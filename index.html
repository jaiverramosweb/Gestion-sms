<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS Aerobolivar - Gestión Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #004aad;
            --secondary: #f4f6f9;
            --text: #333;
            --risk-high: #ff4d4d;
            --risk-med: #ffcc00;
            --risk-low: #4caf50;
            --status-open: #ff9800;
            --status-closed: #6c757d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body { display: flex; height: 100vh; background-color: var(--secondary); color: var(--text); }

        /* Sidebar */
        .sidebar { width: 250px; background-color: var(--primary); color: white; padding: 20px; display: flex; flex-direction: column; }
        .sidebar h2 { margin-bottom: 30px; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .menu-btn {
            background: none; border: none; color: white; padding: 15px; text-align: left; cursor: pointer;
            font-size: 1rem; border-radius: 8px; margin-bottom: 5px; transition: 0.3s; width: 100%; display: flex; align-items: center; gap: 10px;
        }
        .menu-btn:hover, .menu-btn.active { background-color: rgba(255,255,255,0.2); }

        /* Contenido */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Dashboard Cards */
        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .kpi-num { font-size: 2.5rem; font-weight: bold; color: var(--primary); }
        .kpi-label { color: #666; font-size: 0.9rem; }

        /* Formularios */
        .form-container { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 1rem; }
        button.primary-btn { background-color: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 1rem; width: 100%; transition: 0.3s; }
        button.primary-btn:hover { background-color: #003380; }

        /* Tabla y Badges */
        .table-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background-color: #f8f9fa; color: #555; }
        
        .badge { padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; color: white; display: inline-block;}
        .bg-intolerable { background-color: var(--risk-high); }
        .bg-tolerable { background-color: var(--risk-med); color: #333; }
        .bg-aceptable { background-color: var(--risk-low); }
        .status-open { background-color: var(--status-open); }
        .status-closed { background-color: var(--status-closed); }

        /* Botones de Acción */
        .btn-action { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85rem; color: white; transition: 0.2s; margin-right: 5px; }
        .btn-view { background-color: #17a2b8; } /* Azul Info */
        .btn-close { background-color: #28a745; } 
        .btn-reopen { background-color: #6c757d; }

        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .chart-box { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); height: 300px; }

        /* --- MODAL (POP UP) STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 25px; border-radius: 10px; width: 90%; max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; max-height: 90vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-modal { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
        .detail-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 5px; }
        .detail-label { font-weight: bold; color: #555; }
        .detail-value { color: #333; text-align: right; max-width: 60%; }

    </style>
</head>
<body>

    <div class="sidebar">
        <h2><i class="fas fa-plane-departure"></i> Aerobolivar</h2>
        <button class="menu-btn active" onclick="showSection('dashboard')"><i class="fas fa-chart-line"></i> Dashboard</button>
        <button class="menu-btn" onclick="showSection('nuevo')"><i class="fas fa-plus-circle"></i> Nuevo Reporte</button>
        <button class="menu-btn" onclick="showSection('base')"><i class="fas fa-database"></i> Base de Datos</button>
    </div>

    <div class="main-content">
        
        <div id="dashboard" class="section active">
            <h1>Tablero de Control SMS</h1>
            <p>Monitoreo de seguridad operacional en tiempo real.</p>
            <br>
            <div class="kpi-container">
                <div class="kpi-card">
                    <div class="kpi-num" id="totalReports">0</div>
                    <div class="kpi-label">Total Reportes</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-num" id="openReports" style="color: var(--status-open)">0</div>
                    <div class="kpi-label">Reportes Abiertos</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-num" id="highRisk" style="color: var(--risk-high)">0</div>
                    <div class="kpi-label">Riesgos Intolerables</div>
                </div>
            </div>
            <div class="charts-grid">
                <div class="chart-box"><canvas id="chartType"></canvas></div>
                <div class="chart-box"><canvas id="chartStatus"></canvas></div>
            </div>
        </div>

        <div id="nuevo" class="section">
            <h1>Nuevo Reporte de Seguridad</h1>
            <p>Registra un nuevo evento.</p>
            <br>
            <div class="form-container">
                <form id="smsForm" onsubmit="saveReport(event)">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group"><label>Fecha</label><input type="date" id="fecha" required></div>
                        <div class="form-group">
                            <label>Departamento</label>
                            <select id="depto">
                                <option value="SETA">SETA</option>
                                <option value="OMAC-N">OMAC-N</option>
                                <option value="Operaciones">Operaciones</option>
                                <option value="Administración">Administración</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Evento</label>
                        <select id="tipoEvento">
                            <option value="Peligro">Peligro (Hazard)</option>
                            <option value="Incidente">Incidente</option>
                            <option value="Accidente">Accidente</option>
                            <option value="Falla">Reporte de Falla</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Factor SHELL</label>
                        <select id="factor">
                            <option value="Factores Humanos">Factores Humanos</option>
                            <option value="Factores Técnicos">Factores Técnicos</option>
                            <option value="Factores Organizacionales">Factores Organizacionales</option>
                            <option value="Factores Ambientales">Factores Ambientales</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Descripción</label>
                        <textarea id="descripcion" rows="3" required></textarea>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="margin-bottom: 10px;">Matriz de Riesgo</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Probabilidad (1-5)</label>
                                <select id="probabilidad" onchange="calculatePreview()">
                                    <option value="1">1 - Improbable</option>
                                    <option value="2">2 - Remoto</option>
                                    <option value="3">3 - Ocasional</option>
                                    <option value="4">4 - Frecuente</option>
                                    <option value="5">5 - Constante</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Severidad (A-E)</label>
                                <select id="severidad" onchange="calculatePreview()">
                                    <option value="A">A - Catastrófico</option>
                                    <option value="B">B - Peligroso</option>
                                    <option value="C">C - Mayor</option>
                                    <option value="D">D - Menor</option>
                                    <option value="E">E - Insignificante</option>
                                </select>
                            </div>
                        </div>
                        <div id="riskResult" style="padding: 10px; display:none; text-align:center; border-radius:5px; font-weight:bold;"></div>
                    </div>
                    <div class="form-group">
                        <label>Medida de Mitigación</label>
                        <textarea id="accion" rows="2"></textarea>
                    </div>
                    <button type="submit" class="primary-btn">Registrar Reporte</button>
                </form>
            </div>
        </div>

        <div id="base" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>Gestión de Reportes</h1>
                <button onclick="exportToExcel()" style="background: #217346; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-weight:bold;">
                    <i class="fas fa-file-excel"></i> Exportar a Excel
                </button>
            </div>
            <p>Historial completo. Usa el botón "Ojo" para ver detalles.</p>
            <br>
            <div class="table-container">
                <table id="dataTable">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Depto</th>
                            <th>Descripción</th>
                            <th>Riesgo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalDetails" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalle del Reporte</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                </div>
            <div style="margin-top: 20px; text-align: right;">
                <button onclick="closeModal()" class="primary-btn" style="width: auto;">Cerrar Ventana</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DATOS ---
        let smsData = JSON.parse(localStorage.getItem('smsData')) || [
            { id: 1700000000001, fecha: '2024-01-15', depto: 'SETA', tipo: 'Peligro', factor: 'Factores Técnicos', desc: 'Fuga manguera compresor', prob: '4', sev: 'D', indice: '4D', tol: 'Tolerable', accion: 'Cambio manguera', estado: 'Abierto' }
        ];

        function getRiskLevel(prob, sev) {
            const matrix = {
                "5A": "Intolerable", "5B": "Intolerable", "5C": "Intolerable", "5D": "Tolerable", "5E": "Tolerable",
                "4A": "Intolerable", "4B": "Intolerable", "4C": "Intolerable", "4D": "Tolerable", "4E": "Tolerable",
                "3A": "Intolerable", "3B": "Intolerable", "3C": "Tolerable", "3D": "Tolerable", "3E": "Aceptable",
                "2A": "Intolerable", "2B": "Tolerable", "2C": "Tolerable", "2D": "Aceptable", "2E": "Aceptable",
                "1A": "Tolerable", "1B": "Tolerable", "1C": "Aceptable", "1D": "Aceptable", "1E": "Aceptable"
            };
            const key = prob + sev;
            return { indice: key, nivel: matrix[key] || "Desconocido" };
        }

        // --- 2. INTERFAZ ---
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'dashboard') renderDashboard();
            if(id === 'base') renderTable();
        }

        function calculatePreview() {
            const prob = document.getElementById('probabilidad').value;
            const sev = document.getElementById('severidad').value;
            const result = getRiskLevel(prob, sev);
            const div = document.getElementById('riskResult');
            div.style.display = 'block';
            div.innerHTML = `Riesgo: ${result.indice} - ${result.nivel}`;
            
            if (result.nivel === 'Intolerable') { div.style.backgroundColor = '#ffcccc'; div.style.color = '#cc0000'; }
            else if (result.nivel === 'Tolerable') { div.style.backgroundColor = '#fff3cd'; div.style.color = '#856404'; }
            else { div.style.backgroundColor = '#d4edda'; div.style.color = '#155724'; }
        }

        // --- 3. LÓGICA DE NEGOCIO ---
        function saveReport(e) {
            e.preventDefault();
            const prob = document.getElementById('probabilidad').value;
            const sev = document.getElementById('severidad').value;
            const risk = getRiskLevel(prob, sev);

            const newReport = {
                id: Date.now(),
                fecha: document.getElementById('fecha').value,
                depto: document.getElementById('depto').value,
                tipo: document.getElementById('tipoEvento').value,
                factor: document.getElementById('factor').value,
                desc: document.getElementById('descripcion').value,
                prob: prob, sev: sev, indice: risk.indice, tol: risk.nivel,
                accion: document.getElementById('accion').value,
                estado: 'Abierto'
            };

            smsData.push(newReport);
            localStorage.setItem('smsData', JSON.stringify(smsData));
            alert('Reporte registrado.');
            document.getElementById('smsForm').reset();
            document.getElementById('riskResult').style.display = 'none';
            showSection('dashboard');
        }

        function toggleStatus(id) {
            const report = smsData.find(r => r.id === id);
            if(report) {
                report.estado = (report.estado === 'Abierto') ? 'Cerrado' : 'Abierto';
                localStorage.setItem('smsData', JSON.stringify(smsData));
                renderTable(); 
            }
        }

        // --- 4. NUEVO: FUNCIONALIDAD DE MODAL Y EXPORTACIÓN ---
        
        function viewReport(id) {
            const r = smsData.find(d => d.id === id);
            if(!r) return;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="detail-row"><span class="detail-label">ID Sistema:</span> <span class="detail-value">${r.id}</span></div>
                <div class="detail-row"><span class="detail-label">Fecha:</span> <span class="detail-value">${r.fecha}</span></div>
                <div class="detail-row"><span class="detail-label">Departamento:</span> <span class="detail-value">${r.depto}</span></div>
                <div class="detail-row"><span class="detail-label">Tipo:</span> <span class="detail-value">${r.tipo}</span></div>
                <div class="detail-row"><span class="detail-label">Factor:</span> <span class="detail-value">${r.factor}</span></div>
                <div style="margin: 10px 0;">
                    <span class="detail-label">Descripción del Evento:</span>
                    <p style="background:#f9f9f9; padding:10px; border-radius:5px; margin-top:5px;">${r.desc}</p>
                </div>
                <div class="detail-row"><span class="detail-label">Riesgo Calculado:</span> <span class="detail-value"><b>${r.indice} (${r.tol})</b></span></div>
                <div class="detail-row"><span class="detail-label">Estado Actual:</span> <span class="detail-value">${r.estado}</span></div>
                <div style="margin: 10px 0;">
                    <span class="detail-label">Acción Correctiva / Mitigación:</span>
                    <p style="background:#f9f9f9; padding:10px; border-radius:5px; margin-top:5px;">${r.accion}</p>
                </div>
            `;
            document.getElementById('modalDetails').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modalDetails').style.display = 'none';
        }

        function exportToExcel() {
            // 1. Preparar los datos limpios para Excel
            const dataForExcel = smsData.map(item => ({
                "ID Sistema": item.id,
                "Fecha Reporte": item.fecha,
                "Departamento": item.depto,
                "Tipo Evento": item.tipo,
                "Factor SHELL": item.factor,
                "Descripción": item.desc,
                "Índice Riesgo": item.indice,
                "Tolerabilidad": item.tol,
                "Estado": item.estado,
                "Medidas Tomadas": item.accion
            }));

            // 2. Crear hoja de trabajo
            const ws = XLSX.utils.json_to_sheet(dataForExcel);
            
            // 3. Ajustar ancho de columnas (Estético)
            const wscols = [
                {wch: 15}, {wch: 12}, {wch: 10}, {wch: 15}, {wch: 20}, 
                {wch: 40}, {wch: 10}, {wch: 15}, {wch: 10}, {wch: 40}
            ];
            ws['!cols'] = wscols;

            // 4. Crear libro y descargar
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reportes SMS");
            XLSX.writeFile(wb, "Reporte_SMS_Aerobolivar.xlsx");
        }

        function renderTable() {
            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = '';
            const sortedData = [...smsData].sort((a,b) => (a.estado === b.estado) ? 0 : a.estado === 'Abierto' ? -1 : 1);

            sortedData.forEach(row => {
                let riskClass = row.tol === 'Intolerable' ? 'bg-intolerable' : (row.tol === 'Tolerable' ? 'bg-tolerable' : 'bg-aceptable');
                let statusClass = (row.estado === 'Abierto') ? 'status-open' : 'status-closed';
                
                let toggleBtn = (row.estado === 'Abierto') 
                    ? `<button onclick="toggleStatus(${row.id})" class="btn-action btn-close" title="Cerrar Caso"><i class="fas fa-check"></i></button>`
                    : `<button onclick="toggleStatus(${row.id})" class="btn-action btn-reopen" title="Reabrir"><i class="fas fa-undo"></i></button>`;

                const tr = `
                    <tr>
                        <td>${row.fecha}</td>
                        <td>${row.depto}</td>
                        <td>${row.desc.substring(0, 30)}...</td>
                        <td><span class="badge ${riskClass}">${row.indice}</span></td>
                        <td><span class="badge ${statusClass}">${row.estado}</span></td>
                        <td>
                            <button onclick="viewReport(${row.id})" class="btn-action btn-view" title="Ver Detalles"><i class="fas fa-eye"></i></button>
                            ${toggleBtn}
                        </td>
                    </tr>
                `;
                tbody.innerHTML += tr;
            });
        }

        // --- 5. DASHBOARD ---
        let chartType, chartStatus;
        function renderDashboard() {
            document.getElementById('totalReports').innerText = smsData.length;
            document.getElementById('openReports').innerText = smsData.filter(r => r.estado === 'Abierto').length;
            document.getElementById('highRisk').innerText = smsData.filter(r => r.tol === 'Intolerable' && r.estado === 'Abierto').length;

            const factors = {};
            const statusCounts = { 'Abierto': 0, 'Cerrado': 0 };
            smsData.forEach(r => {
                factors[r.factor] = (factors[r.factor] || 0) + 1;
                statusCounts[r.estado] = (statusCounts[r.estado] || 0) + 1;
            });

            const ctx1 = document.getElementById('chartType').getContext('2d');
            if(chartType) chartType.destroy();
            chartType = new Chart(ctx1, {
                type: 'doughnut',
                data: { labels: Object.keys(factors), datasets: [{ data: Object.values(factors), backgroundColor: ['#004aad', '#ffcc00', '#ff4d4d', '#4caf50'] }] },
                options: { plugins: { title: { display: true, text: 'Factores (SHELL)' } } }
            });

            const ctx2 = document.getElementById('chartStatus').getContext('2d');
            if(chartStatus) chartStatus.destroy();
            chartStatus = new Chart(ctx2, {
                type: 'bar',
                data: { labels: ['Abiertos', 'Cerrados'], datasets: [{ label: 'Estado', data: [statusCounts['Abierto'], statusCounts['Cerrado']], backgroundColor: ['#ff9800', '#6c757d'] }] },
                options: { plugins: { title: { display: true, text: 'Gestión de Casos' } }, scales: { y: { beginAtZero: true, ticks: {stepSize: 1} } } }
            });
        }

        renderDashboard();
    </script>
</body>
</html>