<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aerobolivar - Sistema Integral V4.1</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #004aad; /* Azul Aerobolivar */
            --secondary: #f4f6f9;
            --text: #333;
            --risk-high: #dc3545;
            --risk-med: #ffc107;
            --risk-low: #28a745;
            --accent-diario: #6f42c1; /* Morado para Diario */
            --accent-stats: #17a2b8;  /* Cyan para Estadísticas */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        
        body { display: flex; height: 100vh; background-color: var(--secondary); color: var(--text); }

        /* --- SIDEBAR --- */
        .sidebar { width: 260px; background-color: var(--primary); color: white; padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        .sidebar h2 { margin-bottom: 20px; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; font-weight: 700; }
        .version-tag { font-size: 0.75rem; opacity: 0.7; margin-bottom: 25px; background: rgba(255,255,255,0.1); padding: 5px; border-radius: 4px; }
        
        .menu-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; color: rgba(255,255,255,0.6); margin: 15px 0 5px 0; font-weight: bold; }
        
        .menu-btn {
            background: none; border: none; color: white; padding: 12px 15px; text-align: left; cursor: pointer;
            font-size: 0.95rem; border-radius: 6px; margin-bottom: 5px; transition: 0.2s; width: 100%; display: flex; align-items: center; gap: 10px;
        }
        .menu-btn:hover { background-color: rgba(255,255,255,0.1); }
        .menu-btn.active { background-color: rgba(255,255,255,0.25); font-weight: 600; border-left: 4px solid #fff; }

        /* --- CONTENIDO --- */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- DASHBOARD CARDS --- */
        .kpi-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; overflow: hidden; }
        .kpi-card::after { content: ''; position: absolute; top: 0; left: 0; width: 5px; height: 100%; background: var(--primary); }
        .kpi-card.stats::after { background: var(--accent-stats); }
        .kpi-card.diario::after { background: var(--accent-diario); }
        
        .kpi-num { font-size: 2.2rem; font-weight: 800; color: #2c3e50; margin: 10px 0; }
        .kpi-label { color: #666; font-size: 0.9rem; font-weight: 500; }
        .kpi-icon { position: absolute; top: 20px; right: 20px; font-size: 2rem; opacity: 0.1; }

        /* --- FORMULARIOS --- */
        .form-container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 900px; margin: 0 auto 30px auto; }
        .form-header { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.9rem; color: #444; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 0.95rem; transition: 0.3s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(0,74,173,0.1); }

        /* Botones */
        button { cursor: pointer; transition: 0.2s; font-weight: 600; }
        .btn-primary { background-color: var(--primary); color: white; border: none; padding: 12px 24px; border-radius: 6px; width: 100%; }
        .btn-primary:hover { background-color: #003380; transform: translateY(-1px); }
        
        .btn-stats { background-color: var(--accent-stats); color: white; border: none; padding: 12px 24px; border-radius: 6px; width: 100%; }
        .btn-stats:hover { filter: brightness(0.9); }

        .btn-diario { background-color: var(--accent-diario); color: white; border: none; padding: 12px 24px; border-radius: 6px; width: 100%; }
        
        /* Botones Exportar */
        .btn-export { background: #217346; color: white; border: none; padding: 8px 16px; border-radius: 6px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .btn-export:hover { background: #1a5c38; }
        
        /* Botón Específico INAC */
        .btn-export-inac { background: var(--accent-stats); color: white; border: none; padding: 8px 16px; border-radius: 6px; display: flex; align-items: center; gap: 8px; font-size: 0.85rem; }
        .btn-export-inac:hover { background: #117a8b; }

        /* --- TABLAS --- */
        .table-wrapper { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow: hidden; }
        .table-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #f8f9fa; text-align: left; padding: 15px; font-size: 0.85rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 0.95rem; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #fcfcfc; }

        /* Badges */
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
        .bg-high { background: #ffeaea; color: var(--risk-high); }
        .bg-med { background: #fff8d6; color: #d69e00; }
        .bg-low { background: #e8f5e9; color: var(--risk-low); }

        /* Gráficos */
        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 25px; }
        .chart-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); height: 350px; }

        /* Modal */
        .modal-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: white; width: 90%; max-width: 600px; padding: 30px; border-radius: 12px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2><i class="fas fa-plane"></i> Aerobolivar</h2>
        <div class="version-tag">Suite V 4.1 (Export INAC)</div>

        <button class="menu-btn active" onclick="nav('dashboard')">
            <i class="fas fa-home"></i> Inicio / Dashboard
        </button>

        <div class="menu-label">Seguridad (SMS)</div>
        <button class="menu-btn" onclick="nav('sms-new')"><i class="fas fa-plus-circle"></i> Nuevo Reporte</button>
        <button class="menu-btn" onclick="nav('sms-db')"><i class="fas fa-shield-alt"></i> Base de Datos</button>

        <div class="menu-label">Operaciones</div>
        <button class="menu-btn" onclick="nav('stats')"><i class="fas fa-chart-pie"></i> Estadísticas Vuelo</button>
        <button class="menu-btn" onclick="nav('diario')"><i class="fas fa-clipboard-list"></i> Control Diario</button>
    </div>

    <div class="main-content">
        
        <div id="dashboard" class="section active">
            <h1 style="margin-bottom: 25px;">Resumen Operacional</h1>
            
            <div class="kpi-container">
                <div class="kpi-card">
                    <div class="kpi-label">Reportes SMS (Total)</div>
                    <div class="kpi-num" id="kpiSmsTotal">0</div>
                    <i class="fas fa-file-medical-alt kpi-icon"></i>
                </div>
                <div class="kpi-card stats">
                    <div class="kpi-label">Horas Voladas (Mes)</div>
                    <div class="kpi-num" id="kpiFlightHours" style="color: var(--accent-stats)">0.0</div>
                    <i class="fas fa-clock kpi-icon"></i>
                </div>
                <div class="kpi-card diario">
                    <div class="kpi-label">Actividades Diarias</div>
                    <div class="kpi-num" id="kpiDiario" style="color: var(--accent-diario)">0</div>
                    <i class="fas fa-tasks kpi-icon"></i>
                </div>
            </div>

            <div class="charts-row">
                <div class="chart-card">
                    <h3 style="margin-bottom: 15px; font-size: 1rem;">Factores de Riesgo (SMS)</h3>
                    <canvas id="chartFactors"></canvas>
                </div>
                <div class="chart-card">
                    <h3 style="margin-bottom: 15px; font-size: 1rem;">Estado de Reportes</h3>
                    <canvas id="chartStatus"></canvas>
                </div>
            </div>
        </div>

        <div id="sms-new" class="section">
            <div class="form-container">
                <div class="form-header">
                    <h2><i class="fas fa-shield-alt"></i> Nuevo Reporte SMS</h2>
                    <p style="color:#666; margin-top:5px;">Registro de peligros, incidentes o accidentes.</p>
                </div>
                <form onsubmit="saveSms(event)">
                    <div class="form-grid">
                        <div><label>Fecha</label><input type="date" id="sFecha" required></div>
                        <div>
                            <label>Departamento</label>
                            <select id="sDepto">
                                <option>SETA</option><option>OMAC-N</option><option>Operaciones</option><option>Administración</option>
                            </select>
                        </div>
                        <div>
                            <label>Tipo Evento</label>
                            <select id="sTipo">
                                <option>Peligro (Hazard)</option><option>Incidente</option><option>Accidente</option><option>Falla</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div>
                            <label>Clasificación SHELL</label>
                            <select id="sFactor">
                                <option>Factores Humanos</option><option>Factores Técnicos</option><option>Factores Organizacionales</option><option>Factores Ambientales</option>
                            </select>
                        </div>
                    </div>

                    <label>Descripción del Evento</label>
                    <textarea id="sDesc" rows="3" required placeholder="Detalle qué sucedió..."></textarea>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <label style="margin-bottom:15px; text-transform:uppercase;">Evaluación de Riesgo</label>
                        <div class="form-grid">
                            <div>
                                <label>Probabilidad (1-5)</label>
                                <select id="sProb" onchange="calcRisk()"><option value="1">1-Improbable</option><option value="2">2-Remoto</option><option value="3">3-Ocasional</option><option value="4">4-Frecuente</option><option value="5">5-Constante</option></select>
                            </div>
                            <div>
                                <label>Severidad (A-E)</label>
                                <select id="sSev" onchange="calcRisk()"><option value="A">A-Catastrófico</option><option value="B">B-Peligroso</option><option value="C">C-Mayor</option><option value="D">D-Menor</option><option value="E">E-Insignificante</option></select>
                            </div>
                        </div>
                        <div id="riskDisplay" style="text-align:center; font-weight:bold; padding:10px; border-radius:6px; display:none;"></div>
                    </div>

                    <label>Acción Correctiva / Mitigación</label>
                    <textarea id="sAccion" rows="2"></textarea>

                    <button type="submit" class="btn-primary">Guardar Reporte</button>
                </form>
            </div>
        </div>

        <div id="sms-db" class="section">
            <div class="table-wrapper">
                <div class="table-header">
                    <h3>Historial SMS</h3>
                    <button class="btn-export" onclick="downloadExcel()">
                        <i class="fas fa-file-excel"></i> Copia de Seguridad (Todo)
                    </button>
                </div>
                <div style="overflow-x:auto;">
                    <table id="tableSms">
                        <thead><tr><th>Fecha</th><th>Depto</th><th>Descripción</th><th>Riesgo</th><th>Estado</th><th>Acciones</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="stats" class="section">
            <h2 style="margin-bottom: 20px;">Estadísticas de Vuelo (INAC)</h2>
            
            <div class="form-container" style="border-top: 4px solid var(--accent-stats);">
                <div class="form-header">
                    <h3>Registro de Vuelo</h3>
                </div>
                <form onsubmit="saveFlight(event)">
                    <div class="form-grid">
                        <div><label>Fecha</label><input type="date" id="fFecha" required></div>
                        <div><label>Matrícula / Equipo</label><input type="text" id="fMatricula" placeholder="HK-XXXX" required></div>
                        <div><label>Piloto al Mando</label><input type="text" id="fPiloto" required></div>
                    </div>
                    <div class="form-grid">
                        <div><label>Origen</label><input type="text" id="fOrigen" required></div>
                        <div><label>Destino</label><input type="text" id="fDestino" required></div>
                        <div><label>Horas Vuelo</label><input type="number" step="0.1" id="fHoras" required></div>
                    </div>
                    <div class="form-grid">
                        <div><label>Pasajeros (Pax)</label><input type="number" id="fPax" value="0"></div>
                        <div><label>Carga (Kg)</label><input type="number" id="fCarga" value="0"></div>
                        <div><label>Ciclos/Aterrizajes</label><input type="number" id="fCiclos" value="1"></div>
                    </div>
                    <button type="submit" class="btn-stats">Registrar Vuelo</button>
                </form>
            </div>

            <div class="table-wrapper">
                <div class="table-header">
                    <h3>Bitácora de Vuelos</h3>
                    <button class="btn-export-inac" onclick="downloadStatsOnly()">
                        <i class="fas fa-file-excel"></i> Exportar Reporte INAC
                    </button>
                </div>
                <table id="tableFlights">
                    <thead><tr><th>Fecha</th><th>Matrícula</th><th>Ruta</th><th>Horas</th><th>Pax</th><th>Carga</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="diario" class="section">
            <h2 style="margin-bottom: 20px;">Control Diario</h2>
            <div class="form-container" style="border-top: 4px solid var(--accent-diario);">
                <form onsubmit="saveDiario(event)">
                    <div class="form-grid">
                        <div><label>Fecha</label><input type="date" id="dFecha" required></div>
                        <div><label>Responsable</label><input type="text" id="dResp" required></div>
                        <div>
                            <label>Área</label>
                            <select id="dArea"><option>Mantenimiento</option><option>Operaciones</option><option>Limpieza</option></select>
                        </div>
                    </div>
                    <div class="form-grid">
                        <div style="grid-column: span 2"><label>Actividad</label><input type="text" id="dAct" required></div>
                        <div>
                            <label>Novedad</label>
                            <select id="dNov"><option value="NO">Sin Novedad</option><option value="SI">Con Novedad</option></select>
                        </div>
                    </div>
                    <button type="submit" class="btn-diario">Registrar Actividad</button>
                </form>
            </div>
            
            <div class="table-wrapper">
                <table id="tableDiario">
                    <thead><tr><th>Fecha</th><th>Responsable</th><th>Actividad</th><th>Estado</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="modal" class="modal-bg">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>Detalle Reporte</h2>
                <button onclick="document.getElementById('modal').style.display='none'" style="border:none; background:none; font-size:1.5rem;">&times;</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // --- 1. BASE DE DATOS LOCAL ---
        let db = {
            sms: JSON.parse(localStorage.getItem('sms')) || [],
            flights: JSON.parse(localStorage.getItem('flights')) || [],
            diario: JSON.parse(localStorage.getItem('diario')) || []
        };

        // Guardar en LS
        const saveDB = () => {
            localStorage.setItem('sms', JSON.stringify(db.sms));
            localStorage.setItem('flights', JSON.stringify(db.flights));
            localStorage.setItem('diario', JSON.stringify(db.diario));
            updateUI();
        };

        // --- 2. NAVEGACIÓN ---
        function nav(id) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(id).classList.add('active');
            
            // Resaltar botón (Mapeo simple por índice)
            const btns = document.querySelectorAll('.menu-btn');
            if(id === 'dashboard') btns[0].classList.add('active');
            if(id === 'sms-new') btns[1].classList.add('active');
            if(id === 'sms-db') btns[2].classList.add('active');
            if(id === 'stats') btns[3].classList.add('active');
            if(id === 'diario') btns[4].classList.add('active');
            
            updateUI();
        }

        // --- 3. LÓGICA SMS ---
        function getRisk(p, s) {
            const m = { "5A":"Intolerable","5B":"Intolerable","5C":"Intolerable","5D":"Tolerable","5E":"Tolerable",
                        "4A":"Intolerable","4B":"Intolerable","4C":"Intolerable","4D":"Tolerable","4E":"Tolerable",
                        "3A":"Intolerable","3B":"Intolerable","3C":"Tolerable","3D":"Tolerable","3E":"Aceptable",
                        "2A":"Intolerable","2B":"Tolerable","2C":"Tolerable","2D":"Aceptable","2E":"Aceptable",
                        "1A":"Tolerable","1B":"Tolerable","1C":"Aceptable","1D":"Aceptable","1E":"Aceptable" };
            return m[p+s] || "Desconocido";
        }

        function calcRisk() {
            const p = document.getElementById('sProb').value;
            const s = document.getElementById('sSev').value;
            const r = getRisk(p,s);
            const d = document.getElementById('riskDisplay');
            d.style.display = 'block';
            d.innerText = `Riesgo: ${p}${s} - ${r}`;
            d.className = r === 'Intolerable' ? 'bg-high' : (r === 'Tolerable' ? 'bg-med' : 'bg-low');
        }

        function saveSms(e) {
            e.preventDefault();
            const p = document.getElementById('sProb').value;
            const s = document.getElementById('sSev').value;
            db.sms.push({
                id: Date.now(),
                fecha: document.getElementById('sFecha').value,
                depto: document.getElementById('sDepto').value,
                tipo: document.getElementById('sTipo').value,
                factor: document.getElementById('sFactor').value,
                desc: document.getElementById('sDesc').value,
                prob: p, sev: s, risk: getRisk(p,s),
                accion: document.getElementById('sAccion').value,
                estado: 'Abierto'
            });
            saveDB();
            alert('Reporte SMS Guardado');
            e.target.reset();
            document.getElementById('riskDisplay').style.display = 'none';
        }

        // --- 4. LÓGICA VUELOS (ESTADÍSTICAS) ---
        function saveFlight(e) {
            e.preventDefault();
            db.flights.push({
                fecha: document.getElementById('fFecha').value,
                matricula: document.getElementById('fMatricula').value,
                piloto: document.getElementById('fPiloto').value,
                origen: document.getElementById('fOrigen').value,
                destino: document.getElementById('fDestino').value,
                horas: parseFloat(document.getElementById('fHoras').value),
                pax: parseInt(document.getElementById('fPax').value),
                carga: parseFloat(document.getElementById('fCarga').value),
                ciclos: parseInt(document.getElementById('fCiclos').value)
            });
            saveDB();
            alert('Vuelo Registrado');
            e.target.reset();
        }

        // --- 5. LÓGICA DIARIO ---
        function saveDiario(e) {
            e.preventDefault();
            const nov = document.getElementById('dNov').value;
            db.diario.push({
                fecha: document.getElementById('dFecha').value,
                resp: document.getElementById('dResp').value,
                area: document.getElementById('dArea').value,
                act: document.getElementById('dAct').value,
                nov: nov
            });
            saveDB();
            
            if(nov === 'SI' && confirm('¿Registrar reporte SMS por esta novedad?')) {
                nav('sms-new');
                document.getElementById('sDesc').value = `Origen Control Diario: ${document.getElementById('dAct').value}`;
            } else {
                alert('Actividad registrada');
                e.target.reset();
            }
        }

        // --- 6. RENDERIZADO Y GRÁFICOS ---
        function updateUI() {
            // Tablas
            renderTable('tableSms', db.sms, (r) => `
                <td>${r.fecha}</td><td>${r.depto}</td><td>${r.desc.substring(0,30)}...</td>
                <td><span class="badge ${r.risk==='Intolerable'?'bg-high':(r.risk==='Tolerable'?'bg-med':'bg-low')}">${r.prob}${r.sev}</span></td>
                <td>${r.estado}</td>
                <td><button onclick="viewSms(${r.id})" style="border:none;background:none;color:blue"><i class="fas fa-eye"></i></button></td>
            `);
            
            renderTable('tableFlights', db.flights, (r) => `
                <td>${r.fecha}</td><td>${r.matricula}</td><td>${r.origen}-${r.destino}</td>
                <td>${r.horas}</td><td>${r.pax}</td><td>${r.carga}</td>
            `);
            
            renderTable('tableDiario', db.diario, (r) => `
                <td>${r.fecha}</td><td>${r.resp}</td><td>${r.act}</td>
                <td>${r.nov === 'SI' ? '<span class="badge bg-high">NOVEDAD</span>' : '<span class="badge bg-low">OK</span>'}</td>
            `);

            // KPIs Dashboard
            document.getElementById('kpiSmsTotal').innerText = db.sms.length;
            
            const currentMonth = new Date().getMonth();
            const monthlyHours = db.flights
                .filter(f => new Date(f.fecha).getMonth() === currentMonth)
                .reduce((sum, f) => sum + (f.horas || 0), 0);
            document.getElementById('kpiFlightHours').innerText = monthlyHours.toFixed(1);

            document.getElementById('kpiDiario').innerText = db.diario.length;

            renderCharts();
        }

        function renderTable(id, data, rowFn) {
            const tbody = document.querySelector(`#${id} tbody`);
            tbody.innerHTML = '';
            data.slice().reverse().slice(0,10).forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = rowFn(item);
                tbody.appendChild(tr);
            });
        }

        function viewSms(id) {
            const r = db.sms.find(x => x.id === id);
            document.getElementById('modalContent').innerHTML = `
                <p><b>ID:</b> ${r.id}</p><p><b>Fecha:</b> ${r.fecha}</p>
                <p><b>Descripción:</b> ${r.desc}</p>
                <p><b>Mitigación:</b> ${r.accion}</p>
                <br>
                <button class="btn-primary" onclick="toggleState(${r.id})">${r.estado === 'Abierto' ? 'Cerrar Caso' : 'Reabrir Caso'}</button>
            `;
            document.getElementById('modal').style.display = 'flex';
        }

        function toggleState(id) {
            const r = db.sms.find(x => x.id === id);
            r.estado = r.estado === 'Abierto' ? 'Cerrado' : 'Abierto';
            saveDB();
            document.getElementById('modal').style.display = 'none';
        }

        let chart1, chart2;
        function renderCharts() {
            const ctx1 = document.getElementById('chartFactors');
            if(db.sms.length === 0) return;
            const factors = {};
            db.sms.forEach(x => factors[x.factor] = (factors[x.factor]||0)+1);
            if(chart1) chart1.destroy();
            chart1 = new Chart(ctx1, { type: 'doughnut', data: { labels: Object.keys(factors), datasets: [{ data: Object.values(factors), backgroundColor: ['#004aad','#17a2b8','#ffc107','#dc3545'] }] } });

            const ctx2 = document.getElementById('chartStatus');
            const open = db.sms.filter(x=>x.estado==='Abierto').length;
            const closed = db.sms.length - open;
            if(chart2) chart2.destroy();
            chart2 = new Chart(ctx2, { type: 'bar', data: { labels: ['Abiertos', 'Cerrados'], datasets: [{ label: 'Cantidad', data: [open, closed], backgroundColor: ['#ffc107', '#28a745'] }] } });
        }

        // --- 7. EXPORTAR EXCEL GLOBAL ---
        function downloadExcel() {
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(db.sms), "SMS");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(db.flights), "Estadisticas Vuelo");
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(db.diario), "Control Diario");
            XLSX.writeFile(wb, "Aerobolivar_Backup_Full.xlsx");
        }

        // --- 8. NUEVO: EXPORTAR SOLO ESTADÍSTICAS INAC ---
        function downloadStatsOnly() {
            const wb = XLSX.utils.book_new();
            
            // Mapeamos los datos para que salgan bonitos en el Excel
            const flightData = db.flights.map(f => ({
                "Fecha": f.fecha,
                "Matrícula": f.matricula,
                "Piloto": f.piloto,
                "Origen": f.origen,
                "Destino": f.destino,
                "Horas de Vuelo": f.horas,
                "Pax": f.pax,
                "Carga (Kg)": f.carga,
                "Ciclos": f.ciclos
            }));

            const ws = XLSX.utils.json_to_sheet(flightData);
            XLSX.utils.book_append_sheet(wb, ws, "Reporte INAC");
            
            // Nombre del archivo profesional
            XLSX.writeFile(wb, "Reporte_INAC_Vuelos.xlsx");
        }

        // Init
        updateUI();
    </script>
</body>
</html>
